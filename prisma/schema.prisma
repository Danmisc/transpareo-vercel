generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  avatar        String?
  role          String    @default("TENANT")
  password      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  emailVerified DateTime?
  image         String?
  bio           String?
  location      String?
  website       String?
  coverImage    String?
  links         String?
  lastActive    DateTime? @default(now())

  // --- REAL ESTATE PROFILE ---
  pronouns              String?
  siren                 String?
  languages             String? // JSON string or comma separated
  calendlyUrl           String?
  whatsapp              String?
  experienceYears       Int?
  dealsCount            Int?
  assetsUnderManagement String?
  specialities          String? // JSON string or comma separated
  currentStatus         String? // "OPEN_TO_WORK", "HIRING", "INVESTING", etc.
  companyWebsite        String?
  avatarDecoration      String? // CSS class or identifier for avatar frame
  // ---------------------------

  statusMessage        String?
  isInvisible          Boolean                   @default(false)
  company              String?
  school               String?
  industry             String?
  headline             String?
  availability         String?
  isVerified           Boolean                   @default(false)
  reputation           Int                       @default(0)
  pinnedPostId         String?
  twoFactorEnabled     Boolean                   @default(false)
  twoFactorSecret      String?
  phoneNumber          String?
  phoneVerified        DateTime?
  referralCode         String?                   @unique
  referredById         String?
  isPro                Boolean                   @default(false)
  lastSeen             DateTime?                 @default(now())
  showActivityStatus   Boolean                   @default(true)
  featuredPostIds      String?
  socialLinks          String?
  musicUrl             String?
  currentPlan          String                    @default("FREE")
  accounts             Account[]
  analyticsGoals       AnalyticsGoal[]           @relation("UserGoals")
  analyticsSnapshots   AnalyticsSnapshot[]       @relation("UserAnalytics")
  autoInvestSettings   AutoInvestSettings?
  blockedBy            Block[]                   @relation("BlockedUsers")
  blockedUsers         Block[]                   @relation("BlockedBy")
  collections          Collection[]              @relation("UserCollections")
  comments             Comment[]
  commentInteractions  CommentInteraction[]
  createdCommunities   Community[]               @relation("CreatedCommunities")
  communityMemberships CommunityMember[]
  complianceAlerts     ComplianceAlert[]
  contractors          Contractor[]              @relation("OwnerContractors")
  ownedConversations   Conversation[]            @relation("ConversationOwner")
  conversations        ConversationParticipant[]
  creditScore          CreditScore?
  endorsementsReceived Endorsement[]             @relation("EndorsementsReceived")
  endorsementsGiven    Endorsement[]             @relation("EndorsementsGiven")
  featureUsage         FeatureUsage[]
  followedBy           Follow[]                  @relation("followedBy")
  following            Follow[]                  @relation("following")
  interactions         Interaction[]
  investorProfile      InvestorProfile?          @relation("UserInvestorProfile")
  kycProfile           KYCProfile?
  leases               Lease[]                   @relation("UserLeases")
  legalConversations   LegalConversation[]
  linkedAccounts       LinkedAccount[]
  listings             Listing[]                 @relation("UserListings")
  loans                Loan[]                    @relation("ActiveLoans")
  loanApplications     LoanProject[]             @relation("BorrowerLoans")
  loanRequests         LoanRequest[]
  sentMessages         Message[]
  messageReactions     MessageReaction[]
  messageStatus        MessageReadStatus[]
  sentNotifications    Notification[]            @relation("NotificationSender")
  certifications       UserCertification[]
  skills               UserSkill[]
  notifications        Notification[]            @relation("UserNotifications")
  notificationSettings NotificationSettings?
  pollVotes            PollVote[]
  portfolioItems       PortfolioItem[]           @relation("UserPortfolio")
  posts                Post[]
  postCollaborations   PostCollaborator[]        @relation("CollaboratorUser")
  postImpressions      PostImpression[]          @relation("UserImpressions")
  profileViewsReceived ProfileView[]             @relation("ProfileViewsReceived")
  profileViewsGiven    ProfileView[]             @relation("ProfileViewsGiven")
  properties           Property[]                @relation("UserProperties")
  propertyAnalytics    PropertyAnalytics[]       @relation("UserPropertyAnalytics")
  propertyReviews      PropertyReview[]          @relation("UserPropertyReviews")
  reports              Report[]                  @relation("Reporter")
  reviewEligibilities  ReviewEligibility[]
  savedPosts           SavedPost[]               @relation("UserSavedPosts")
  searchHistory        SearchHistory[]
  securityLogs         SecurityLog[]
  sessions             Session[]
  receivedVouches      SocialVouch[]             @relation("VouchedFor")
  sentVouches          SocialVouch[]             @relation("VouchedBy")
  stories              Story[]
  storyHighlights      StoryHighlight[]          @relation("UserHighlights")
  storyViews           StoryView[]
  tenantDossier        TenantDossier?
  referrer             User?                     @relation("UserReferrals", fields: [referredById], references: [id])
  referrals            User[]                    @relation("UserReferrals")
  pinnedPost           Post?                     @relation("UserPinnedPost", fields: [pinnedPostId], references: [id])
  achievements         UserAchievement[]         @relation("UserAchievements")
  badges               UserBadge[]
  subscription         UserSubscription?
  vibeReviews          VibeReview[]
  wallet               Wallet?
  walletNotifications  WalletNotification[]      @relation("WalletNotifications")

  // My Pitch / Video Bio
  pitchVideoUrl       String?
  pitchVideoThumbnail String?
  pitchDuration       Float?
  experiences         UserExperience[]
  searchCriteria      UserSearchCriteria?

  // Moderation
  bannedUsers          CommunityBannedUser[]    @relation("BannedBy")
  receivedBans         CommunityBannedUser[]
  moderationLogs       CommunityModerationLog[]
  CommunityJoinRequest CommunityJoinRequest[]
  CommunityInvitation  CommunityInvitation[]
}

model UserSearchCriteria {
  id         String   @id @default(cuid())
  userId     String   @unique
  isActive   Boolean  @default(false)
  type       String   @default("BUY") // BUY, RENT, INVEST
  minBudget  Float?
  maxBudget  Float?
  minSurface Float?
  maxSurface Float?
  location   String?
  rooms      String?
  assetTypes String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PortfolioItem {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  imageUrl    String?
  category    String
  price       Float?
  location    String?
  link        String?
  featured    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation("UserPortfolio", fields: [userId], references: [id], onDelete: Cascade)
}

model Endorsement {
  id           String   @id @default(cuid())
  giverId      String
  receiverId   String
  skill        String
  message      String?
  relationship String?
  createdAt    DateTime @default(now())
  receiver     User     @relation("EndorsementsReceived", fields: [receiverId], references: [id], onDelete: Cascade)
  giver        User     @relation("EndorsementsGiven", fields: [giverId], references: [id], onDelete: Cascade)

  @@unique([giverId, receiverId, skill])
}

model StoryHighlight {
  id        String   @id @default(cuid())
  userId    String
  title     String
  coverUrl  String?
  storyIds  String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("UserHighlights", fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model SecurityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  status    String
  ipAddress String?
  userAgent String?
  metadata  String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model LinkedAccount {
  id           String        @id @default(cuid())
  userId       String
  providerId   String
  providerName String
  accountName  String
  mask         String
  balance      Float
  currency     String        @default("EUR")
  status       String        @default("ACTIVE")
  lastSync     DateTime      @default(now())
  accessToken  String?
  refreshToken String?
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Post {
  id            String             @id @default(cuid())
  content       String
  image         String?
  published     Boolean            @default(true)
  authorId      String
  type          String             @default("TEXT")
  metadata      String?
  tags          String?
  location      String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  communityId   String?
  scheduledAt   DateTime?
  visibility    String             @default("PUBLIC")
  allowComments Boolean            @default(true)
  allowDuets    Boolean            @default(true)
  allowDownload Boolean            @default(true)
  contentRating String             @default("CLEAN")
  videoCategory String?
  isEdited      Boolean            @default(false)
  editedAt      DateTime?
  quotedPostId  String?
  isDraft       Boolean            @default(false)
  publishedAt   DateTime?
  threadId      String?
  threadOrder   Int?
  isCarousel    Boolean            @default(false)
  contentFormat String             @default("TEXT")
  comments      Comment[]
  interactions  Interaction[]
  liveStream    LiveStream?
  notifications Notification[]
  pollVotes     PollVote[]
  quotedPost    Post?              @relation("QuotedPosts", fields: [quotedPostId], references: [id])
  quotes        Post[]             @relation("QuotedPosts")
  community     Community?         @relation(fields: [communityId], references: [id])
  author        User               @relation(fields: [authorId], references: [id])
  attachments   PostAttachment[]
  codeBlocks    PostCodeBlock[]
  collaborators PostCollaborator[] @relation("PostCollaborators")
  embedLinks    PostEmbedLink[]
  impressions   PostImpression[]   @relation("PostImpressions")
  mapEmbeds     PostMapEmbed[]
  views         PostView[]
  savedBy       SavedPost[]        @relation("PostSavedBy")
  pinnedBy      User[]             @relation("UserPinnedPost")
  video         Video?
  hashtags      Hashtag[]          @relation("HashtagToPost")
}

model PostAttachment {
  id        String   @id @default(cuid())
  postId    String
  url       String
  type      String   @default("IMAGE")
  order     Int      @default(0)
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model Interaction {
  id        String   @id @default(cuid())
  type      String
  value     String?
  userId    String
  postId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, postId, type])
  @@index([postId, type])
  @@index([postId, createdAt])
  @@index([userId])
}

model PostView {
  id             String   @id @default(cuid())
  postId         String
  userId         String?
  watchTimeMs    Int      @default(0)
  completionRate Float    @default(0)
  didLike        Boolean  @default(false)
  didComment     Boolean  @default(false)
  didShare       Boolean  @default(false)
  didSave        Boolean  @default(false)
  didSkip        Boolean  @default(false)
  didHide        Boolean  @default(false)
  didReport      Boolean  @default(false)
  source         String?
  deviceType     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  post           Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([postId, createdAt])
  @@index([userId])
}

model Comment {
  id            String               @id @default(cuid())
  content       String
  userId        String
  postId        String
  parentId      String?
  likes         Int                  @default(0)
  createdAt     DateTime             @default(now())
  media         String?
  isPinned      Boolean              @default(false)
  isEdited      Boolean              @default(false)
  isHidden      Boolean              @default(false)
  deletedAt     DateTime?
  timestamp     Float?
  parent        Comment?             @relation("CommentReplies", fields: [parentId], references: [id])
  children      Comment[]            @relation("CommentReplies")
  post          Post                 @relation(fields: [postId], references: [id])
  user          User                 @relation(fields: [userId], references: [id])
  interactions  CommentInteraction[]
  notifications Notification[]
}

model CommentInteraction {
  id        String   @id @default(cuid())
  type      String
  value     String?
  userId    String
  commentId String
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, commentId, type])
}

model Follow {
  id            String   @id @default(cuid())
  followerId    String
  followingId   String
  createdAt     DateTime @default(now())
  isCloseFriend Boolean  @default(false)
  isMuted       Boolean  @default(false)
  type          String   @default("FOLLOWER")
  following     User     @relation("followedBy", fields: [followingId], references: [id])
  follower      User     @relation("following", fields: [followerId], references: [id])

  @@unique([followerId, followingId])
}

model Block {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())
  blocked   User     @relation("BlockedUsers", fields: [blockedId], references: [id], onDelete: Cascade)
  blocker   User     @relation("BlockedBy", fields: [blockerId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
}

model Notification {
  id        String   @id @default(cuid())
  type      String
  message   String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    String
  senderId  String?
  postId    String?
  commentId String?
  comment   Comment? @relation(fields: [commentId], references: [id])
  post      Post?    @relation(fields: [postId], references: [id])
  sender    User?    @relation("NotificationSender", fields: [senderId], references: [id])
  user      User     @relation("UserNotifications", fields: [userId], references: [id])
}

model Report {
  id          String     @id @default(cuid())
  reason      String
  details     String?
  status      String     @default("PENDING")
  createdAt   DateTime   @default(now())
  reporterId  String?
  targetType  String // POST, COMMENT, USER
  targetId    String
  communityId String?
  community   Community? @relation(fields: [communityId], references: [id])
  reporter    User?      @relation("Reporter", fields: [reporterId], references: [id])
}

model NotificationSettings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  emailNotifications  Boolean  @default(true)
  pushNotifications   Boolean  @default(true)
  notifyOnLike        Boolean  @default(true)
  notifyOnComment     Boolean  @default(true)
  notifyOnMention     Boolean  @default(true)
  notifyOnFollow      Boolean  @default(true)
  readReceiptsEnabled Boolean  @default(true)
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Hashtag {
  id        String   @id @default(cuid())
  tag       String   @unique
  createdAt DateTime @default(now())
  posts     Post[]   @relation("HashtagToPost")
}

model SearchHistory {
  id        String   @id @default(cuid())
  query     String
  userId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Community {
  id          String            @id @default(cuid())
  name        String
  slug        String            @unique
  description String?
  image       String?
  coverImage  String?
  type        String            @default("PUBLIC")
  city        String?
  zipCode     String?
  category    String?
  rules       String?
  creatorId   String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  creator     User              @relation("CreatedCommunities", fields: [creatorId], references: [id])
  members     CommunityMember[]
  posts       Post[]
  vibeReviews VibeReview[]

  // Advanced Community Features
  theme    String? // JSON string for branding (colors, styles)
  settings String? // JSON string for comprehensive settings

  joinRequestsEnabled Boolean @default(false)

  roles          CommunityRole[]
  invitations    CommunityInvitation[]
  joinRequests   CommunityJoinRequest[]
  moderationLogs CommunityModerationLog[]
  bannedUsers    CommunityBannedUser[]
  reports        Report[]
}

model CommunityRole {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String   @default("#000000")
  icon        String?
  communityId String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Permissions
  canManageMembers Boolean @default(false)
  canManageRoles   Boolean @default(false)
  canManagePosts   Boolean @default(false)
  canManageInvites Boolean @default(false)
  canViewAnalytics Boolean @default(false)
  canPinPosts      Boolean @default(false)
  isDefault        Boolean @default(false)

  community Community         @relation(fields: [communityId], references: [id], onDelete: Cascade)
  members   CommunityMember[]

  @@unique([communityId, name])
}

model CommunityInvitation {
  id          String    @id @default(cuid())
  communityId String
  inviterId   String
  code        String    @unique
  maxUses     Int       @default(1)
  uses        Int       @default(0)
  expiresAt   DateTime?
  roleId      String?   // Role to assign upon join
  createdAt   DateTime  @default(now())

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  inviter   User      @relation(fields: [inviterId], references: [id], onDelete: Cascade)
}

model CommunityJoinRequest {
  id          String   @id @default(cuid())
  communityId String
  userId      String
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  message     String?  // User's message to mods
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([communityId, userId])
}

model VibeReview {
  id              String    @id @default(cuid())
  communityId     String
  userId          String
  safetyRating    Int
  noiseRating     Int
  transportRating Int
  comment         String?
  createdAt       DateTime  @default(now())
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  community       Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([communityId, userId])
}

model CommunityMember {
  id          String   @id @default(cuid())
  communityId String
  userId      String
  role        String   @default("MEMBER") // Basic fallback role
  roleId      String? // Link to custom role
  joinedAt    DateTime @default(now())

  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  community  Community      @relation(fields: [communityId], references: [id], onDelete: Cascade)
  customRole CommunityRole? @relation(fields: [roleId], references: [id])

  @@unique([communityId, userId])
}

model Badge {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  icon        String
  description String
  condition   String?
  category    String      @default("GENERAL")
  createdAt   DateTime    @default(now())
  users       UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  awardedAt DateTime @default(now())
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
}

model Collection {
  id          String      @id @default(cuid())
  name        String
  description String?
  userId      String
  isPublic    Boolean     @default(false)
  type        String      @default("DEFAULT")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  user        User        @relation("UserCollections", fields: [userId], references: [id])
  savedPosts  SavedPost[] @relation("CollectionSavedPosts")
}

model SavedPost {
  id           String      @id @default(cuid())
  userId       String
  postId       String
  collectionId String?
  progress     Float       @default(0.0)
  createdAt    DateTime    @default(now())
  collection   Collection? @relation("CollectionSavedPosts", fields: [collectionId], references: [id])
  post         Post        @relation("PostSavedBy", fields: [postId], references: [id])
  user         User        @relation("UserSavedPosts", fields: [userId], references: [id])

  @@unique([userId, postId, collectionId])
}

model Video {
  id          String  @id @default(cuid())
  postId      String  @unique
  url         String
  thumbnail   String?
  duration    Float?
  format      String?
  views       Int     @default(0)
  transcript  String?
  chapters    String?
  resolution  String?
  aspectRatio String?
  fps         Int?
  codec       String?
  post        Post    @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model LiveStream {
  id           String    @id @default(cuid())
  postId       String    @unique
  status       String    @default("LIVE")
  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  peakViewers  Int       @default(0)
  recordingUrl String?
  post         Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model Story {
  id        String      @id @default(cuid())
  userId    String
  mediaUrl  String
  mediaType String      @default("IMAGE")
  caption   String?
  createdAt DateTime    @default(now())
  expiresAt DateTime
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  views     StoryView[]

  @@index([userId])
}

model StoryView {
  id       String   @id @default(cuid())
  storyId  String
  viewerId String
  viewedAt DateTime @default(now())
  viewer   User     @relation(fields: [viewerId], references: [id], onDelete: Cascade)
  story    Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([storyId, viewerId])
}

model Conversation {
  id            String                    @id @default(cuid())
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  lastMessageAt DateTime                  @default(now())
  name          String?
  description   String?
  image         String?
  type          String                    @default("DM")
  isGroup       Boolean                   @default(false)
  category      String?
  permissions   String?
  slug          String?                   @unique
  isOfficial    Boolean                   @default(false)
  ownerId       String?
  owner         User?                     @relation("ConversationOwner", fields: [ownerId], references: [id])
  participants  ConversationParticipant[]
  messages      Message[]
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime     @default(now())
  role           String       @default("MEMBER")
  lastReadAt     DateTime?
  lastSeenAt     DateTime?
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
}

model Message {
  id             String              @id @default(cuid())
  conversationId String
  senderId       String
  content        String?
  image          String?
  file           String?
  audio          String?
  type           String              @default("TEXT")
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  isDeleted      Boolean             @default(false)
  deletedAt      DateTime?
  isEdited       Boolean             @default(false)
  editedAt       DateTime?
  isPinned       Boolean             @default(false)
  replyToId      String?
  metadata       String?
  sender         User                @relation(fields: [senderId], references: [id], onDelete: Cascade)
  conversation   Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  replyTo        Message?            @relation("MessageReplies", fields: [replyToId], references: [id])
  replies        Message[]           @relation("MessageReplies")
  attachments    MessageAttachment[]
  reactions      MessageReaction[]
  readStatuses   MessageReadStatus[]

  @@index([conversationId, createdAt])
  @@index([senderId])
}

model MessageAttachment {
  id        String   @id @default(cuid())
  messageId String
  url       String
  type      String
  name      String?
  size      Int?
  mimeType  String?
  createdAt DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

model MessageReaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
}

model MessageReadStatus {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
}

model Listing {
  id               String              @id @default(cuid())
  title            String
  description      String
  price            Float
  type             String              @default("RENT")
  propertyType     String              @default("APARTMENT")
  surface          Float
  rooms            Int
  bedrooms         Int?
  amenities        String?
  floor            Int?
  totalFloors      Int?
  isFurnished      Boolean             @default(false)
  heatingType      String?
  energyClass      String?
  dpeValue         Int?
  gesValue         Int?
  charges          Float?
  deposit          Float?
  availabilityDate DateTime?
  contactName      String?
  contactPhone     String?
  contactEmail     String?
  virtualTourUrl   String?
  address          String
  latitude         Float
  longitude        Float
  userId           String
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  user             User                @relation("UserListings", fields: [userId], references: [id], onDelete: Cascade)
  images           ListingImage[]
  applications     RentalApplication[]
}

model ListingImage {
  id        String  @id @default(cuid())
  url       String
  listingId String
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
}

model PropertyReview {
  id                  String   @id @default(cuid())
  address             String
  latitude            Float
  longitude           Float
  rating              Int
  comment             String?
  pros                String?
  cons                String?
  thermalScore        Int?
  acousticScore       Int?
  luminosityScore     Int?
  humidityScore       Int?
  commonAreasScore    Int?
  safetyScore         Int?
  transportScore      Int?
  responsivenessScore Int?
  depositReturnScore  Int?
  networkScore        Int?
  rentPaid            Int?
  rentYear            Int?
  surface             Float?
  isFurnished         Boolean?
  isVerifiedTenant    Boolean  @default(false)
  userId              String
  createdAt           DateTime @default(now())
  user                User     @relation("UserPropertyReviews", fields: [userId], references: [id])
}

model ReviewEligibility {
  id               String    @id @default(cuid())
  userId           String
  status           String    @default("PENDING")
  rejectionReason  String?
  proofDocumentUrl String?
  proofType        String?
  address          String
  moveInDate       DateTime?
  moveOutDate      DateTime?
  agencyName       String?
  notaryReference  String?
  checkedAt        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TenantDossier {
  id                String                 @id @default(cuid())
  userId            String                 @unique
  status            String                 @default("INCOMPLETE")
  description       String?
  videoPitchUrl     String?
  openBankingStatus String                 @default("NOT_CONNECTED")
  verifiedIncome    Int?
  solvencyScore     Int?
  groupId           String?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  accesses          DossierAccess[]
  documents         DossierDocument[]
  guarantors        DossierGuarantor[]
  rentPayments      RentPayment[]
  applications      RentalApplication[]
  group             DossierGroup?          @relation(fields: [groupId], references: [id])
  user              User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  profile           TenantProfile?
  recommendations   TenantRecommendation[]
}

model TenantProfile {
  id             String        @id @default(cuid())
  dossierId      String        @unique
  status         String?
  employer       String?
  jobTitle       String?
  contractType   String?
  startDate      DateTime?
  netIncome      Int?
  variableIncome Int?
  taxReference   Int?
  linkedinUrl    String?
  workMode       String?
  bio            String?
  phone          String?
  birthDate      DateTime?
  nationality    String?
  familyStatus   String?
  childrenCount  Int           @default(0)
  pets           String?
  smoker         Boolean       @default(false)
  transport      String?
  moveInDate     DateTime?
  durationIntent String?
  searchArea     String?
  currentStatus  String?
  currentRent    Int?
  currentAddress String?
  reasonForMove  String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  dossier        TenantDossier @relation(fields: [dossierId], references: [id], onDelete: Cascade)
}

model TenantRecommendation {
  id          String        @id @default(cuid())
  dossierId   String
  authorName  String
  authorEmail String
  authorRole  String
  rating      Int
  comment     String
  status      String        @default("VERIFIED")
  createdAt   DateTime      @default(now())
  dossier     TenantDossier @relation(fields: [dossierId], references: [id], onDelete: Cascade)
}

model RentPayment {
  id        String        @id @default(cuid())
  dossierId String
  month     DateTime
  amount    Float
  status    String        @default("PAID")
  proofUrl  String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  dossier   TenantDossier @relation(fields: [dossierId], references: [id], onDelete: Cascade)
}

model DossierGroup {
  id        String          @id @default(cuid())
  name      String
  type      String          @default("COUPLE")
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  members   TenantDossier[]
}

model DossierDocument {
  id             String            @id @default(cuid())
  dossierId      String
  guarantorId    String?
  type           String
  status         String            @default("PENDING")
  url            String
  name           String
  size           Int
  mimeType       String
  watermarkedUrl String?
  createdAt      DateTime          @default(now())
  guarantor      DossierGuarantor? @relation(fields: [guarantorId], references: [id], onDelete: Cascade)
  dossier        TenantDossier     @relation(fields: [dossierId], references: [id], onDelete: Cascade)
}

model DossierAccess {
  id             String             @id @default(cuid())
  dossierId      String
  recipientEmail String?
  viewerId       String?
  token          String             @unique
  expiresAt      DateTime?
  createdAt      DateTime           @default(now())
  dossier        TenantDossier      @relation(fields: [dossierId], references: [id], onDelete: Cascade)
  logs           DossierAccessLog[]
}

model DossierAccessLog {
  id        String        @id @default(cuid())
  accessId  String
  ipAddress String?
  userAgent String?
  viewedAt  DateTime      @default(now())
  access    DossierAccess @relation(fields: [accessId], references: [id], onDelete: Cascade)
}

model DossierGuarantor {
  id        String            @id @default(cuid())
  dossierId String
  firstName String
  lastName  String
  email     String
  phone     String?
  relation  String?
  status    String            @default("PENDING")
  token     String?           @unique
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  documents DossierDocument[]
  dossier   TenantDossier     @relation(fields: [dossierId], references: [id], onDelete: Cascade)
}

model RentalApplication {
  id            String        @id @default(cuid())
  dossierId     String
  listingId     String?
  externalLabel String?
  status        String        @default("SENT")
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  listing       Listing?      @relation(fields: [listingId], references: [id])
  dossier       TenantDossier @relation(fields: [dossierId], references: [id], onDelete: Cascade)
}

model Property {
  id               String              @id @default(cuid())
  ownerId          String
  title            String
  address          String
  type             String
  surface          Float
  acquisitionPrice Float?
  loanAmount       Float?
  loanRate         Float?
  loanDuration     Int?
  fiscalMode       String              @default("LMNP")
  imageUrl         String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  expenses         Expense[]
  leases           Lease[]
  tickets          MaintenanceTicket[]
  owner            User                @relation("UserProperties", fields: [ownerId], references: [id], onDelete: Cascade)
  assets           PropertyAsset[]
  documents        PropertyDocument[]
}

model Expense {
  id            String    @id @default(cuid())
  propertyId    String
  amount        Float
  date          DateTime
  category      String
  description   String?
  isDeductible  Boolean   @default(true)
  frequency     String    @default("ONCE")
  lastGenerated DateTime?
  attachmentUrl String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  property      Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model Lease {
  id            String    @id @default(cuid())
  propertyId    String
  tenantName    String
  tenantEmail   String?
  tenantId      String?
  startDate     DateTime
  endDate       DateTime?
  rentAmount    Float
  chargesAmount Float
  status        String    @default("ACTIVE")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  tenant        User?     @relation("UserLeases", fields: [tenantId], references: [id])
  property      Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  payments      Payment[]
}

model Payment {
  id        String   @id @default(cuid())
  leaseId   String
  amount    Float
  date      DateTime @default(now())
  status    String   @default("PAID")
  type      String   @default("RENT")
  frequency String   @default("ONCE")
  createdAt DateTime @default(now())
  lease     Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
}

model MaintenanceTicket {
  id            String             @id @default(cuid())
  propertyId    String
  title         String
  description   String
  priority      String             @default("MEDIUM")
  status        String             @default("OPEN")
  category      String?
  provider      String?
  contractorId  String?
  proContact    String?
  cost          Float?
  scheduledDate DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  contractor    Contractor?        @relation(fields: [contractorId], references: [id])
  property      Property           @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  attachments   TicketAttachment[]
  timeline      TicketEvent[]
  messages      TicketMessage[]
}

model TicketMessage {
  id         String            @id @default(cuid())
  ticketId   String
  senderName String
  senderRole String            @default("OWNER")
  content    String
  isMe       Boolean           @default(false)
  createdAt  DateTime          @default(now())
  ticket     MaintenanceTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
}

model TicketEvent {
  id          String            @id @default(cuid())
  ticketId    String
  type        String
  title       String
  description String?
  createdAt   DateTime          @default(now())
  ticket      MaintenanceTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
}

model TicketAttachment {
  id        String            @id @default(cuid())
  ticketId  String
  name      String
  url       String
  type      String
  createdAt DateTime          @default(now())
  ticket    MaintenanceTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
}

model PropertyDocument {
  id             String    @id @default(cuid())
  propertyId     String
  name           String
  url            String
  type           String
  category       String    @default("OTHER")
  expirationDate DateTime?
  tags           String?
  fileSize       Int?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  property       Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model PropertyAsset {
  id              String            @id @default(cuid())
  propertyId      String
  name            String
  type            String
  installDate     DateTime
  lifespan        Int
  healthScore     Int               @default(100)
  status          String            @default("GOOD")
  lastServiceDate DateTime?
  nextServiceDate DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  tasks           MaintenanceTask[]
  property        Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model MaintenanceTask {
  id        String        @id @default(cuid())
  assetId   String
  title     String
  dueDate   DateTime
  isDone    Boolean       @default(false)
  createdAt DateTime      @default(now())
  asset     PropertyAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)
}

model Contractor {
  id          String              @id @default(cuid())
  ownerId     String
  name        String
  jobType     String
  companyName String?
  phone       String?
  email       String?
  website     String?
  rating      Float?
  isVerified  Boolean             @default(false)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  owner       User                @relation("OwnerContractors", fields: [ownerId], references: [id], onDelete: Cascade)
  tickets     MaintenanceTicket[]
}

model LegalConversation {
  id        String         @id @default(cuid())
  userId    String
  title     String?        @default("Nouvelle Conversation")
  updatedAt DateTime       @updatedAt
  createdAt DateTime       @default(now())
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  LegalMessage[]

  @@index([userId])
}

model LegalMessage {
  id             String            @id @default(cuid())
  conversationId String
  role           String
  content        String
  createdAt      DateTime          @default(now())
  conversation   LegalConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model Wallet {
  id                 String              @id @default(cuid())
  userId             String              @unique
  balance            Float               @default(0.0)
  invested           Float               @default(0.0)
  locked             Float               @default(0.0)
  currency           String              @default("EUR")
  iban               String?
  ledgerAccountId    String?             @unique
  status             String              @default("ACTIVE")
  tier               String              @default("STANDARD")
  bic                String?
  address            String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  cards              BankCard[]
  beneficiaries      Beneficiary[]
  investments        Investment[]
  pockets            Pocket[]
  recurringTransfers RecurringTransfer[]
  transactions       Transaction[]
  ledgerAccount      LedgerAccount?      @relation(fields: [ledgerAccountId], references: [id])
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Beneficiary {
  id                 String              @id @default(cuid())
  walletId           String
  name               String
  iban               String
  bic                String?
  avatar             String?
  lastTransferAt     DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  wallet             Wallet              @relation(fields: [walletId], references: [id], onDelete: Cascade)
  recurringTransfers RecurringTransfer[]

  @@index([walletId])
}

model Transaction {
  id               String         @id @default(cuid())
  walletId         String
  amount           Float
  type             String
  category         String         @default("OTHER")
  status           String         @default("PENDING")
  reference        String?
  externalId       String?
  balanceAfter     Float?
  counterpartyName String?
  counterpartyIban String?
  counterpartyLogo String?
  linkedAccountId  String?
  cardId           String?
  pocketId         String?
  flagged          Boolean        @default(false)
  flagReason       String?
  complianceNotes  String?
  reviewedBy       String?
  reviewedAt       DateTime?
  metadata         String?
  description      String?
  isRecurring      Boolean        @default(false)
  recurringGroupId String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  journalEntry     JournalEntry?
  pocket           Pocket?        @relation(fields: [pocketId], references: [id])
  card             BankCard?      @relation(fields: [cardId], references: [id])
  linkedAccount    LinkedAccount? @relation(fields: [linkedAccountId], references: [id])
  wallet           Wallet         @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId, createdAt])
  @@index([category])
  @@index([linkedAccountId])
  @@index([flagged])
}

model BankCard {
  id               String        @id @default(cuid())
  walletId         String
  type             String
  status           String        @default("ACTIVE")
  design           String?       @default("TEAL")
  label            String?
  panLast4         String
  expiry           String
  cvv              String?
  pin              String?
  monthlyLimit     Float         @default(1000)
  currentSpend     Float         @default(0)
  contactless      Boolean       @default(true)
  onlinePayments   Boolean       @default(true)
  atmWithdrawals   Boolean       @default(true)
  locationSecurity Boolean       @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  wallet           Wallet        @relation(fields: [walletId], references: [id], onDelete: Cascade)
  transactions     Transaction[]
}

model Pocket {
  id                 String        @id @default(cuid())
  walletId           String
  name               String
  goalAmount         Float?
  currency           String        @default("EUR")
  emoji              String?
  image              String?
  balance            Float         @default(0)
  autoSaveEnabled    Boolean       @default(false)
  roundUpMultiplier  Float?
  recurringAmount    Float?
  recurringFrequency String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  wallet             Wallet        @relation(fields: [walletId], references: [id], onDelete: Cascade)
  transactions       Transaction[]
}

model KYCProfile {
  id           String        @id @default(cuid())
  userId       String        @unique
  tier         Int           @default(0)
  status       String        @default("IDLE")
  riskScore    Int           @default(0)
  riskLevel    String        @default("LOW")
  documentType String?
  documentUrl  String?
  selfieUrl    String?
  verifiedAt   DateTime?
  lastCheckAt  DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  documents    KYCDocument[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model KYCDocument {
  id        String     @id @default(cuid())
  profileId String
  type      String
  status    String     @default("PENDING")
  url       String
  metadata  String?
  expiresAt DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  profile   KYCProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

model LoanProject {
  id          String          @id @default(cuid())
  title       String
  description String
  amount      Float
  funded      Float           @default(0.0)
  duration    Int
  apr         Float
  riskGrade   String
  status      String          @default("DRAFT")
  borrowerId  String
  location    String?
  projectType String?
  images      String?
  documents   String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  investments Investment[]
  borrower    User            @relation("BorrowerLoans", fields: [borrowerId], references: [id])
  repayments  LoanRepayment[]
  updates     ProjectUpdate[]
}

model LedgerAccount {
  id        String            @id @default(cuid())
  name      String
  type      String
  currency  String            @default("EUR")
  balance   Decimal           @default(0)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  lines     TransactionLine[]
  wallet    Wallet?
}

model JournalEntry {
  id            String            @id @default(cuid())
  description   String
  date          DateTime          @default(now())
  status        String            @default("POSTED")
  reference     String?
  transactionId String?           @unique
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  transaction   Transaction?      @relation(fields: [transactionId], references: [id])
  lines         TransactionLine[]
}

model TransactionLine {
  id           String        @id @default(cuid())
  accountId    String
  entryId      String
  amount       Decimal
  direction    String
  balanceAfter Decimal?
  createdAt    DateTime      @default(now())
  entry        JournalEntry  @relation(fields: [entryId], references: [id], onDelete: Cascade)
  account      LedgerAccount @relation(fields: [accountId], references: [id])
}

model Investment {
  id                String      @id @default(cuid())
  walletId          String
  loanId            String
  amount            Float
  interestEarned    Float       @default(0.0)
  status            String      @default("ACTIVE")
  signedContractUrl String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  loan              LoanProject @relation(fields: [loanId], references: [id])
  wallet            Wallet      @relation(fields: [walletId], references: [id])
}

model LoanRepayment {
  id        String      @id @default(cuid())
  loanId    String
  dueDate   DateTime
  amount    Float
  principal Float
  interest  Float
  status    String      @default("PENDING")
  paidAt    DateTime?
  createdAt DateTime    @default(now())
  loan      LoanProject @relation(fields: [loanId], references: [id])
}

model AutoInvestSettings {
  id            String   @id @default(cuid())
  userId        String   @unique
  isEnabled     Boolean  @default(false)
  minInterest   Float    @default(5.0)
  maxDuration   Int      @default(24)
  riskTolerance String
  amountPerLoan Float    @default(50.0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProjectUpdate {
  id        String      @id @default(cuid())
  loanId    String
  title     String
  content   String
  imageUrl  String?
  createdAt DateTime    @default(now())
  loan      LoanProject @relation(fields: [loanId], references: [id], onDelete: Cascade)
}

model SocialVouch {
  id           String   @id @default(cuid())
  voucherId    String
  targetId     String
  relationship String   @default("FRIEND")
  createdAt    DateTime @default(now())
  target       User     @relation("VouchedFor", fields: [targetId], references: [id])
  voucher      User     @relation("VouchedBy", fields: [voucherId], references: [id])

  @@unique([voucherId, targetId])
}

model ComplianceAlert {
  id            String    @id @default(cuid())
  userId        String
  transactionId String?
  type          String
  severity      String    @default("MEDIUM")
  status        String    @default("PENDING")
  title         String
  description   String
  resolvedBy    String?
  resolvedAt    DateTime?
  resolution    String?
  sarFiled      Boolean   @default(false)
  sarReference  String?
  sarFiledAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([severity])
}

model TransactionRule {
  id             String   @id @default(cuid())
  name           String
  description    String?
  isActive       Boolean  @default(true)
  priority       Int      @default(0)
  criteria       String
  setCategory    String?
  setDescription String?
  setRecurring   Boolean?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  entityType String
  entityId   String
  action     String
  changes    String?
  ipAddress  String?
  userAgent  String?
  metadata   String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model LoanRequest {
  id             String   @id @default(cuid())
  userId         String
  amount         Float
  duration       Int
  reason         String
  category       String
  description    String?
  status         String   @default("PENDING")
  declaredIncome Float?
  creditScore    Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  loan           Loan?
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model Loan {
  id                String              @id @default(cuid())
  requestId         String              @unique
  borrowerId        String
  amount            Float
  interestRate      Float
  duration          Int
  monthlyPayment    Float
  totalRepaid       Float               @default(0)
  remainingBalance  Float
  startDate         DateTime            @default(now())
  endDate           DateTime
  nextPaymentDate   DateTime?
  status            String              @default("ACTIVE")
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  borrower          User                @relation("ActiveLoans", fields: [borrowerId], references: [id])
  request           LoanRequest         @relation(fields: [requestId], references: [id])
  repaymentSchedule RepaymentSchedule[]

  @@index([borrowerId])
}

model RepaymentSchedule {
  id        String    @id @default(cuid())
  loanId    String
  dueDate   DateTime
  amount    Float
  principal Float
  interest  Float
  status    String    @default("PENDING")
  paidAt    DateTime?
  createdAt DateTime  @default(now())
  loan      Loan      @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@index([loanId])
  @@index([dueDate])
}

model CreditScore {
  id         String   @id @default(cuid())
  userId     String   @unique
  score      Int      @default(500)
  history    String?
  factors    String?
  lastUpdate DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RecurringTransfer {
  id             String      @id @default(cuid())
  walletId       String
  beneficiaryId  String
  amount         Float
  description    String?
  frequency      String
  dayOfMonth     Int?
  dayOfWeek      Int?
  startDate      DateTime
  endDate        DateTime?
  nextExecution  DateTime
  lastExecution  DateTime?
  status         String      @default("ACTIVE")
  executionCount Int         @default(0)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  beneficiary    Beneficiary @relation(fields: [beneficiaryId], references: [id], onDelete: Cascade)
  wallet         Wallet      @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([nextExecution])
  @@index([status])
}

model WalletNotification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  amount    Float?
  reference String?
  read      Boolean  @default(false)
  urgent    Boolean  @default(false)
  metadata  String?
  createdAt DateTime @default(now())
  user      User     @relation("WalletNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model InvestorProfile {
  id                   String    @id @default(cuid())
  userId               String    @unique
  sophistication       String    @default("NON_SOPHISTICATED")
  investmentExperience String    @default("NONE")
  riskUnderstanding    Boolean   @default(false)
  canAffordLoss        Boolean   @default(false)
  investmentHorizon    String?
  investmentObjective  String?
  monthlyIncome        Float?
  totalPatrimony       Float?
  testCompletedAt      DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation("UserInvestorProfile", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sophistication])
}

model RiskAcknowledgment {
  id              String   @id @default(cuid())
  userId          String
  loanId          String
  acknowledgedAt  DateTime @default(now())
  capitalLossRisk Boolean  @default(true)
  liquidityRisk   Boolean  @default(true)
  defaultRisk     Boolean  @default(true)
  platformRisk    Boolean  @default(false)

  @@unique([userId, loanId])
  @@index([userId])
  @@index([loanId])
}

model InvestmentLimitLog {
  id              String   @id @default(cuid())
  userId          String
  year            Int
  totalInvested   Float    @default(0)
  investmentCount Int      @default(0)
  limitType       String   @default("ANNUAL_NO_KYC")
  limitAmount     Float    @default(1000)
  warningsShown   Int      @default(0)
  blockersHit     Int      @default(0)
  updatedAt       DateTime @updatedAt

  @@unique([userId, year])
  @@index([userId])
  @@index([year])
}

model PollVote {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  optionIdx Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model ProfileView {
  id        String   @id @default(cuid())
  viewerId  String
  viewedId  String
  createdAt DateTime @default(now())
  viewed    User     @relation("ProfileViewsReceived", fields: [viewedId], references: [id], onDelete: Cascade)
  viewer    User     @relation("ProfileViewsGiven", fields: [viewerId], references: [id], onDelete: Cascade)

  @@index([viewedId, createdAt])
  @@index([viewerId])
}

model AnalyticsSnapshot {
  id                String   @id @default(cuid())
  userId            String
  date              DateTime @default(now())
  period            String   @default("DAILY")
  profileViews      Int      @default(0)
  uniqueVisitors    Int      @default(0)
  searchAppearances Int      @default(0)
  totalImpressions  Int      @default(0)
  totalLikes        Int      @default(0)
  totalComments     Int      @default(0)
  totalShares       Int      @default(0)
  totalSaves        Int      @default(0)
  followers         Int      @default(0)
  following         Int      @default(0)
  newFollowers      Int      @default(0)
  unfollowers       Int      @default(0)
  engagementRate    Float    @default(0)
  avgPostReach      Float    @default(0)
  propertyViews     Int      @default(0)
  investmentClicks  Int      @default(0)
  contactRequests   Int      @default(0)
  leadScore         Float    @default(0)
  user              User     @relation("UserAnalytics", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, period])
  @@index([userId, date])
  @@index([userId, period])
}

model PostImpression {
  id         String   @id @default(cuid())
  postId     String
  userId     String?
  source     String   @default("FEED")
  deviceType String?
  duration   Int?
  createdAt  DateTime @default(now())
  user       User?    @relation("UserImpressions", fields: [userId], references: [id])
  post       Post     @relation("PostImpressions", fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt])
  @@index([userId])
  @@index([source])
}

model PropertyAnalytics {
  id               String   @id @default(cuid())
  propertyId       String
  userId           String
  date             DateTime @default(now())
  totalViews       Int      @default(0)
  uniqueViews      Int      @default(0)
  favoriteCount    Int      @default(0)
  shareCount       Int      @default(0)
  contactClicks    Int      @default(0)
  phoneClicks      Int      @default(0)
  emailClicks      Int      @default(0)
  scheduleClicks   Int      @default(0)
  investInterest   Int      @default(0)
  simulationClicks Int      @default(0)
  documentViews    Int      @default(0)
  investorViews    Int      @default(0)
  buyerViews       Int      @default(0)
  avgViewDuration  Float    @default(0)
  user             User     @relation("UserPropertyAnalytics", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([propertyId, date])
  @@index([userId, date])
  @@index([propertyId])
}

model UserAchievement {
  id         String   @id @default(cuid())
  userId     String
  type       String
  unlockedAt DateTime @default(now())
  progress   Int      @default(100)
  metadata   String?
  user       User     @relation("UserAchievements", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId])
}

model AnalyticsGoal {
  id        String   @id @default(cuid())
  userId    String
  type      String
  target    Int
  current   Int      @default(0)
  period    String
  startDate DateTime
  endDate   DateTime
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation("UserGoals", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, period])
  @@index([userId, completed])
}

model PostCollaborator {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  role      String   @default("CONTRIBUTOR")
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  user      User     @relation("CollaboratorUser", fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation("PostCollaborators", fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([userId, status])
}

model PostCodeBlock {
  id       String  @id @default(cuid())
  postId   String
  language String  @default("text")
  code     String
  filename String?
  order    Int     @default(0)
  post     Post    @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model PostEmbedLink {
  id          String  @id @default(cuid())
  postId      String
  url         String
  title       String?
  description String?
  imageUrl    String?
  siteName    String?
  faviconUrl  String?
  type        String  @default("LINK")
  order       Int     @default(0)
  post        Post    @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model PostMapEmbed {
  id        String  @id @default(cuid())
  postId    String
  latitude  Float
  longitude Float
  address   String?
  zoomLevel Int     @default(15)
  post      Post    @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model SubscriptionPlan {
  id                   String             @id @default(cuid())
  name                 String             @unique
  displayName          String
  description          String?
  price                Decimal            @default(0)
  yearlyPrice          Decimal?
  interval             String             @default("month")
  stripePriceIdMonthly String?
  stripePriceIdYearly  String?
  features             String             @default("{}")
  order                Int                @default(0)
  isPopular            Boolean            @default(false)
  isActive             Boolean            @default(true)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  subscriptions        UserSubscription[]
}

model UserSubscription {
  id                   String           @id @default(cuid())
  userId               String           @unique
  planId               String
  status               String           @default("ACTIVE")
  stripeCustomerId     String?
  stripeSubscriptionId String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean          @default(false)
  trialEnd             DateTime?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  plan                 SubscriptionPlan @relation(fields: [planId], references: [id])
  user                 User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeSubscriptionId])
}

model FeatureUsage {
  id        String   @id @default(cuid())
  userId    String
  feature   String
  count     Int      @default(0)
  period    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, feature, period])
  @@index([userId, feature])
}

model PlatformFee {
  id            String    @id @default(cuid())
  transactionId String
  type          String
  grossAmount   Decimal
  feePercent    Decimal
  feeAmount     Decimal
  netAmount     Decimal
  userId        String?
  status        String    @default("PENDING")
  collectedAt   DateTime?
  metadata      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([transactionId])
  @@index([type])
  @@index([userId])
}

// ============================================
// AUTH TOKENS FOR EMAIL VERIFICATION & PASSWORD RESET
// ============================================

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime? // Track when token was used (for audit)

  @@index([token])
}

model UserExperience {
  id          String    @id @default(cuid())
  userId      String
  title       String
  company     String
  location    String?
  startDate   DateTime
  endDate     DateTime? // Null means "Present"
  description String?
  type        String    @default("REAL_ESTATE") // REAL_ESTATE, WORK, EDUCATION
  logo        String? // Optional URL or identifier
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserCertification {
  id            String    @id @default(cuid())
  userId        String
  name          String
  issuer        String
  issueDate     DateTime
  expiryDate    DateTime?
  credentialId  String?
  credentialUrl String?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserSkill {
  id                String   @id @default(cuid())
  userId            String
  name              String
  category          String   @default("PROFESSIONAL") // PROFESSIONAL, PERSONAL
  endorsementsCount Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CommunityModerationLog {
  id          String   @id @default(cuid())
  communityId String
  action      String // BAN, KICK, DELETE_POST, UPDATE_SETTINGS
  moderatorId String
  targetId    String? // UserId or PostId depending on action
  reason      String?
  createdAt   DateTime @default(now())

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  moderator User      @relation(fields: [moderatorId], references: [id], onDelete: Cascade)

  @@index([communityId])
}

model CommunityBannedUser {
  id          String    @id @default(cuid())
  communityId String
  userId      String
  bannedAt    DateTime  @default(now())
  bannedBy    String
  reason      String?
  expiresAt   DateTime? // Null for permanent

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  banner    User      @relation("BannedBy", fields: [bannedBy], references: [id])

  @@unique([communityId, userId])
}

model CommunityRole {
  id          String   @id @default(cuid())
  communityId String
  name        String
  color       String   @default("#000000")
  icon        String? // Phosphor icon name or similar (e.g. "Shield", "Star")
  permissions String // JSON string defining granular permissions
  position    Int      @default(0) // For hierarchy sorting
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  community           Community             @relation(fields: [communityId], references: [id], onDelete: Cascade)
  members             CommunityMember[]
  CommunityInvitation CommunityInvitation[]

  @@unique([communityId, name])
  @@index([communityId])
}

model CommunityJoinRequest {
  id          String   @id @default(cuid())
  communityId String
  userId      String
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  message     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([communityId, userId])
  @@index([communityId, status])
}

model CommunityInvitation {
  id          String   @id @default(cuid())
  communityId String
  inviterId   String
  email       String? // For external invites
  userId      String? // For internal invites
  token       String   @unique
  status      String   @default("PENDING") // PENDING, ACCEPTED, EXPIRED, REVOKED
  roleId      String? // Invite as specific role
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  maxUses     Int      @default(1)
  uses        Int      @default(0)

  community Community      @relation(fields: [communityId], references: [id], onDelete: Cascade)
  inviter   User           @relation(fields: [inviterId], references: [id], onDelete: Cascade)
  role      CommunityRole? @relation(fields: [roleId], references: [id])

  @@index([communityId])
  @@index([token])
}
